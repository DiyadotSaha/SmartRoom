<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Real-Time HVAC Control Simulator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0; padding: 0;
      background: #f9f9f9;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 32px;
      background: #ffffff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    header h1 {
      margin: 0; font-size: 24px;
    }
    header p {
      margin: 4px 0 0;
      font-size: 16px; color: #555;
    }
    .toggles {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }
    .toggles label {
      font-size: 14px;
    }
    .toggles input[type="checkbox"] { transform: scale(1.2); }
    .toggles .mode {
      display: flex; gap: 8px;
      font-size: 14px;
    }
    main {
      display: flex;
      gap: 24px;
      padding: 24px 32px;
    }
    section {
      background: #fff;
      padding: 16px;
      border-radius: 8px;
      flex: 1;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    section h2 {
      margin-top: 0; font-size: 18px; color: #333;
    }
    .metrics {
      display: flex;
      gap: 16px;
      margin-top: 12px;
    }
    .metric {
      flex: 1;
      background: #fafafa;
      padding: 12px;
      text-align: center;
      border-radius: 6px;
      border: 1px solid #eee;
    }
    .metric span.value {
      display: block;
      font-size: 20px;
      margin-top: 4px;
      color: #111;
    }
    /* Table at bottom (optional) */
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 24px 0;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px; text-align: center;
      font-size: 14px;
    }
    th {
      background: #f0f0f0;
    }
  </style>
</head>
<body>

  <header>
    <div>
      <h1>Real-Time HVAC Control Simulator</h1>
      <p>Live Monitoring, Prediction, and Energy Analytics</p>
    </div>
    <div class="toggles">
      <label><input type="checkbox" checked> Predictive Control</label>
      <div class="mode">
        <label><input type="radio" name="mode" value="reactive" checked> Reactive</label>
        <label><input type="radio" name="mode" value="predictive"> Predictive</label>
      </div>
    </div>
  </header>

  <main>
    <!-- Temperature Section -->
    <section>
      <h2>Room Temperature</h2>
      <canvas id="tempChart"></canvas>
      <div class="metrics">
        <div class="metric">
          <div>Current Temperature</div>
          <span id="curTemp" class="value">— °C</span>
        </div>
        <div class="metric">
          <div>Comfort Status</div>
          <span id="comfortStatus" class="value">—</span>
        </div>
        <div class="metric">
          <div>HVAC State</div>
          <span id="hvacState" class="value">—</span>
        </div>
      </div>
    </section>

    <!-- Energy Section -->
    <section>
      <h2>Energy Consumption</h2>
      <canvas id="energyChart"></canvas>
      <div class="metrics">
        <div class="metric">
          <div>Total Energy Used</div>
          <span id="totalEnergy" class="value">— kWh</span>
        </div>
        <div class="metric">
          <div>Average Power</div>
          <span id="avgPower" class="value">— kW</span>
        </div>
      </div>
    </section>
  </main>

  <script>
    // WebSocket to your FastAPI server
    const ws = new WebSocket("ws://localhost:8000/ws");

    // Chart.js setup
    const maxPoints = 30;
    const timeLabels = [];
    const temps = [];
    const energies = [];

    const tempCtx = document.getElementById("tempChart").getContext("2d");
    const tempChart = new Chart(tempCtx, {
      type: 'line',
      data: {
        labels: timeLabels,
        datasets: [{
          label: "Room Temp (°C)",
          data: temps,
          borderColor: "black",
          fill: false,
        }]
      },
      options: {
        scales: {
          x: { title: { display: true, text: 'Time' } },
          y: { title: { display: true, text: '°C' }, min: 18, max: 28 }
        }
      }
    });

    const energyCtx = document.getElementById("energyChart").getContext("2d");
    const energyChart = new Chart(energyCtx, {
      type: 'line',
      data: {
        labels: timeLabels,
        datasets: [{
          label: "Energy (kWh)",
          data: energies,
          borderColor: "blue",
          fill: false,
        }]
      },
      options: {
        scales: {
          x: { title: { display: true, text: 'Time' } },
          y: { title: { display: true, text: 'kWh' } }
        }
      }
    });

    // Helper to update metrics
    function updateMetrics(data) {
      const t = parseFloat(data.room_temp);
      const e = parseFloat(data.energy);
      const cmd = data.command || 'Off';

      document.getElementById("curTemp").textContent = `${t.toFixed(1)}°C`;
      document.getElementById("comfortStatus").textContent =
        (t >= 21 && t <= 23) ? 'In Range' : 'Out of Range';
      document.getElementById("hvacState").textContent = cmd;

      // energy metrics
      const total = energies.reduce((a,b)=>a+b, 0);
      const avg   = (energies.length>0) ? total/energies.length* (60/1) : 0;
      document.getElementById("totalEnergy").textContent = `${total.toFixed(2)} kWh`;
      document.getElementById("avgPower").textContent   = `${avg.toFixed(2)} kW`;
    }

    ws.onmessage = evt => {
      const data = JSON.parse(evt.data);
      const ts = new Date(data.time).toLocaleTimeString();

      // push data
      timeLabels.push(ts);
      temps.push(+data.room_temp);
      energies.push(+data.energy);

      // trim old
      if(timeLabels.length>maxPoints){
        timeLabels.shift();
        temps.shift();
        energies.shift();
      }

      tempChart.update();
      energyChart.update();
      updateMetrics(data);
    };
  </script>
</body>
</html>
